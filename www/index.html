<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<title>RoyaleAPI</title>
		<link rel="shortcut icon" href="favicon.ico">
		<link rel="stylesheet" href="static/css/bootstrap.min.css">
		<script src="static/js/jquery.min.js"></script>
		<script src="static/js/vue.min.js"></script>
		<script src="static/js/babel.min.js"></script>
		<script src="static/js/Chart.min.js"></script>
	</head>
	<body>
		<div class="container" id="app">
			<div class="row">
				<div class="col">
					<h2><img :width="40" :src="clan.badge.image"> {{ clan.name }}</h2>
					<p>数据更新时间：{{ Math.ceil((new Date()).getTime() / 1000 - now) }} 秒前</p>
					<p>
						部落战统计说明：
						1) <span style="color: #0a0;">绿色</span>为战斗日胜利，灰色为未打或失败；
						2) 柱的高度是集卡日收集卡牌数量；
						3) 最右侧的是最近战斗；
						4) 未统计正在进行的战斗。
					</p>
					<p>
						捐赠统计说明：
						1) <span style="color: #0a0;">绿色</span>填充区域为捐赠数量，<span style="color: #00a;">蓝色</span>线条为接受捐赠数量；
						2) 横坐标 0 表示现在，-7 表示 7 天前。
					</p>
					<p><a href="https://github.com/yuantailing/royale-stat">开源项目</a>，欢迎提 issue。</p>
				</div>
			</div>
			<div class="member-wrap" v-for="member in clan.members" :tag="member.tag">
				<div class="row">
					<div style="width: 100%; background-color: #ffd; border: solid 1px #ddb;">
						<div style="margin: 3px 10px 3px 10px; font-family: Microsoft YaHei;">
							<b>{{ member.name }}</b>
							({{ member.role }})
							<span style="float: right;">{{ member.trophies }} 杯</span>
						</div>
					</div>
				</div>
				<div class="row" style="border: solid 1px #ddb; margin-bottom: 15px;">
					<div class="col-md-12 col-lg-6">
						<div style="margin-left: 10px;">部落战统计</div>
						<div><canvas id="war-chart" width="400" height="120"></canvas></div>
					</div>
					<div class="col-md-12 col-lg-6">
						<div style="margin-left: 10px;">捐赠统计</div>
						<div><canvas id="donation-chart" width="400" height="120"></canvas></div>
					</div>
				</div>
			</div>
		</div>
		<script type="text/babel">
'use strict';
$(document).ready(function() {
	$.get('data/data.json?_t=' + (new Date()).getTime(), (data) => {
		document.title = data.clan.name;
		var link = document.querySelector("link[rel*='icon']") || document.createElement('link');
		link.href = data.clan.badge.image;
		var app = new Vue({
			el: '#app',
			data: {
				now: data.now,
				clan: data.clan,
				war_log: data.war_log,
			},
		});
		$('.member-wrap').each((_, wrap) => {
			data.clan.members.forEach((member) => {
				if (member.tag == wrap.getAttribute('tag')) {
					var marks = [];
					data.war_log.forEach((war) => {
						var cardsEarned = 0;
						var wins = 0;
						war.participants.forEach((participant) => {
							if (participant.tag == member.tag) {
								cardsEarned = participant.cardsEarned;
								wins = participant.wins;
							}
						});
						marks.push([cardsEarned, wins]);
					});
					marks.reverse();
					var ctx = $(wrap).find('#war-chart')[0].getContext('2d');
					var myChart = new Chart(ctx, {
						type: 'bar',
						data: {
							labels: marks.map((_, idx) => { return idx + 1; }),
							datasets: [{
								label: '获得卡牌',
								data: marks.map(([cardsEarned, wins]) => { return cardsEarned; }),
								backgroundColor: marks.map(([cardsEarned, wins]) => {
									if (wins == 0)
										return 'rgba(0, 0, 0, .2)';
									else
										return 'rgba(0, 255, 0, .2)';
								}),
								borderWidth: 2
							}]
						},
						options: {
							legend: {
								display: false
							},
							scales: {
								yAxes: [{
									ticks: {
										beginAtZero: true,
										max: 1700,
										stepSize: 300
									}
								}],
								xAxes: [{
									ticks: {
										display: false
									}
								}]
							}
						}
					});
					var num_day = 7;
					var coords = [];
					data.history.forEach(({time, clan}) => {
						clan.members.forEach((his) => {
							if (member.tag == his.tag) {
								var delta = -(data.now - time) / 86400;
								coords.push([
									delta,
									his.donations,
									his.donationsReceived,
								]);
							}
						});
					});
					ctx = $(wrap).find('#donation-chart')[0].getContext('2d');
					myChart = new Chart(ctx, {
						type: 'scatter',
						data: {
							datasets: [{
									showLine: true,
									label: '捐赠',
									data: coords.map(([delta, donations, donationsReceived]) => {
										return { x: delta, y: donations, };
									}),
									backgroundColor: 'rgba(0, 255, 0, .2)',
									pointRadius: 0
								}, {
									showLine: true,
									label: '接受捐赠',
									data: coords.map(([delta, donations, donationsReceived]) => {
										return { x: delta, y: donationsReceived, };
									}),
									backgroundColor: 'rgba(0, 0, 0, 0)',
									borderColor: 'rgba(0, 0, 255, .6)',
									borderWidth: 2,
									pointRadius: 0
								}]
						},
						options: {
							scales: {
								xAxes: [{
									ticks: {
										min: -7,
										max: 0
									}
								}],
								yAxes: [{
									ticks: {
										beginAtZero: true,
										max: 1300,
										stepSize: 200
									}
								}]
							}
						}
					});
				}
			});
		});
	});
});
		</script>
	</body>
</html>
